<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mini Bug Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-3">Log Issue</h2>

    <form id="issueForm" enctype="multipart/form-data" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Track</label>
        <select name="track" class="form-select" required>
          <option>AP</option>
          <option>RP</option>
          <option>Common</option>
          <option>LI</option>
          <option>ES</option>
        </select>
      </div>

      <div class="col-md-9">
        <label class="form-label">Summary (â‰¤ 250 chars)</label>
        <input type="text" name="summary" class="form-control" maxlength="250" required />
      </div>

      <div class="col-12">
        <label class="form-label">Description</label>
        <textarea name="description" class="form-control" rows="4" placeholder="Describe the issue..."></textarea>
      </div>

      <div class="col-md-3">
        <label class="form-label">Scenario ID</label>
        <input type="text" name="scenario_id" class="form-control" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Step No</label>
        <input type="text" name="step_no" class="form-control" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Attachments (max 5)</label>
        <input type="file" name="attachments" class="form-control" multiple />
      </div>

      <div class="col-md-3">
        <label class="form-label">Raised by</label>
        <input type="text" name="raised_by" class="form-control" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Assignee</label>
        <input type="text" name="assignee" class="form-control" />
      </div>

      <div class="col-md-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option>Open</option>
          <option>Fixed</option>
          <option>Deployed</option>
          <option>Closed</option>
        </select>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-primary">Save</button>
        <span id="formMsg" class="ms-3 text-success"></span>
        <span id="formErr" class="ms-3 text-danger"></span>
      </div>
    </form>

    <hr class="my-4" />

    <!-- Issues Table Header with Search and Download -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="mb-0">Issues</h3>
      <div class="d-flex gap-2">
        <input id="searchBox" class="form-control" placeholder="Search summary/assignee..." />
        <a href="/issues/download" class="btn btn-success">Download Excel</a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Track</th>
            <th>Summary</th>
            <th>Status</th>
            <th>Raised By</th>
            <th>Assignee</th>
            <th>Scenario ID</th>
            <th>Step No</th>
            <th>Attachments</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="issueTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Issue Details Modal -->
  <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Issue Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const tbody = document.getElementById("issueTableBody");
    const searchBox = document.getElementById("searchBox");
    const formMsg = document.getElementById("formMsg");
    const formErr = document.getElementById("formErr");
    let cache = [];

    function fmtDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString();
    }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
    }

    function statusColor(status) {
      switch ((status || "").toLowerCase()) {
        case "open": return "secondary";
        case "fixed": return "warning";
        case "deployed": return "info";
        case "closed": return "success";
        default: return "secondary";
      }
    }

    function render(issues) {
      const q = (searchBox.value || "").toLowerCase();
      const filtered = issues.filter(i =>
        (i.summary || "").toLowerCase().includes(q) ||
        (i.assignee || "").toLowerCase().includes(q)
      );

      tbody.innerHTML = filtered.map(i => {
        const links = (i.attachments || []).map(fn => 
          `<a href="/uploads/${encodeURIComponent(fn)}" target="_blank">${fn.split("_").slice(1).join("_")}</a>`).join("<br/>") || "-";

        return `
          <tr style="cursor:pointer;" class="issue-row" data-id="${i.id}">
            <td>${i.id}</td>
            <td>${i.track}</td>
            <td>${escapeHtml(i.summary)}</td>
            <td><span class="badge bg-${statusColor(i.status)}">${i.status}</span></td>
            <td>${escapeHtml(i.raised_by||"")}</td>
            <td>${escapeHtml(i.assignee||"")}</td>
            <td>${escapeHtml(i.scenario_id||"")}</td>
            <td>${escapeHtml(i.step_no||"")}</td>
            <td>${links}</td>
            <td>${fmtDate(i.created_at)}</td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll('.issue-row').forEach(row => {
        row.onclick = () => {
          const id = row.dataset.id;
          const issue = cache.find(i => i.id == id);
          if(issue) showDetails(issue);
        };
      });
    }

    function showDetails(issue) {
      const attachmentsHtml = (issue.attachments || []).map(fn => `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <a href="/uploads/${encodeURIComponent(fn)}" target="_blank">${fn.split("_").slice(1).join("_")}</a>
          <button class="btn btn-sm btn-danger" onclick="deleteAttachment(${issue.id}, '${fn}')">Delete</button>
        </div>`).join("") || "-";

      document.getElementById("modalTitle").textContent = `${issue.summary} [${issue.status}]`;
      document.getElementById("modalBody").innerHTML = `
        <p><b>Track:</b> ${issue.track}</p>
        <p><b>Description:</b> ${escapeHtml(issue.description||"-")}</p>
        <p><b>Raised By:</b> ${escapeHtml(issue.raised_by||"-")}</p>
        <div class="mb-2"><label><b>Scenario ID:</b></label><input type="text" id="modalScenario" class="form-control" value="${escapeHtml(issue.scenario_id||"")}" /></div>
        <div class="mb-2"><label><b>Step No:</b></label><input type="text" id="modalStep" class="form-control" value="${escapeHtml(issue.step_no||"")}" /></div>
        <div class="mb-2"><label><b>Assignee:</b></label><input type="text" id="modalAssignee" class="form-control" value="${escapeHtml(issue.assignee||"")}" /></div>
        <div class="mb-2"><label><b>Status:</b></label><select id="modalStatus" class="form-select">
          <option${issue.status==="Open"?" selected":""}>Open</option>
          <option${issue.status==="Fixed"?" selected":""}>Fixed</option>
          <option${issue.status==="Deployed"?" selected":""}>Deployed</option>
          <option${issue.status==="Closed"?" selected":""}>Closed</option>
        </select></div>
        <div class="mb-2"><label><b>Attachments:</b></label>${attachmentsHtml}</div>
        <div class="mb-2"><label><b>Add New Attachments (max 5)</b></label><input type="file" id="modalNewAttachments" class="form-control" multiple /></div>
        <p><b>Created:</b> ${fmtDate(issue.created_at)}</p>
        <div class="mt-2">
          <button id="modalSaveBtn" class="btn btn-primary me-2">Save Changes</button>
          <button id="modalCloseBtn" class="btn btn-secondary">Close</button>
          <span id="modalMsg" class="ms-2 text-success"></span>
          <span id="modalErr" class="ms-2 text-danger"></span>
        </div>
      `;

      const modalEl = document.getElementById('issueModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      document.getElementById("modalCloseBtn").onclick = () => {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if(modalInstance) modalInstance.hide();
        const backdrops = document.getElementsByClassName('modal-backdrop');
        while(backdrops.length>0) backdrops[0].parentNode.removeChild(backdrops[0]);
      };

      document.getElementById("modalSaveBtn").onclick = async () => {
        const newAssignee = document.getElementById("modalAssignee").value.trim();
        const newStatus = document.getElementById("modalStatus").value;
        const newScenario = document.getElementById("modalScenario").value.trim();
        const newStep = document.getElementById("modalStep").value.trim();
        const newFiles = document.getElementById("modalNewAttachments").files;

        const fd = new FormData();
        fd.append("assignee", newAssignee);
        fd.append("status", newStatus);
        fd.append("scenario_id", newScenario);
        fd.append("step_no", newStep);
        for (let f of newFiles) fd.append("attachments", f);

        document.getElementById("modalMsg").textContent = "";
        document.getElementById("modalErr").textContent = "";

        try {
          const res = await fetch(`/issues/${issue.id}`, { method: "PATCH", body: fd });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || ("HTTP " + res.status));
          }
          const updated = await res.json();
          cache = cache.map(i => i.id===updated.id?updated:i);
          render(cache);
          showDetails(updated);
          document.getElementById("modalMsg").textContent="Updated!";
          setTimeout(()=>document.getElementById("modalMsg").textContent="",2000);
        } catch(err) {
          document.getElementById("modalErr").textContent=err.message||"Failed to update.";
        }
      };
    }

    async function deleteAttachment(issueId, filename) {
      if (!confirm("Delete this attachment?")) return;

      try {
        const res = await fetch(`/issues/${issueId}/attachments/${encodeURIComponent(filename)}`, { method: "DELETE" });
        if (!res.ok) throw new Error("Failed to delete");
        const updated = await res.json();
        cache = cache.map(i => i.id === updated.id ? updated : i);
        render(cache);
        const modalEl = document.getElementById('issueModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance && modalEl.classList.contains('show')) {
          showDetails(updated);
          document.getElementById("modalMsg").textContent = "Attachment deleted!";
          setTimeout(()=>document.getElementById("modalMsg").textContent="",2000);
        }
      } catch(err) {
        alert(err.message);
      }
    }

    async function loadIssues() {
      const res = await fetch("/issues");
      cache = await res.json();
      render(cache);
    }

    document.getElementById("issueForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      formMsg.textContent = "";
      formErr.textContent = "";
      const form = e.target;
      const files = form.querySelector('input[name="attachments"]').files;
      if(files.length>5){ formErr.textContent="Max 5 attachments allowed."; return; }
      const fd = new FormData(form);
      try {
        const res = await fetch("/issues",{method:"POST",body:fd});
        if(!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error||("HTTP "+res.status)); }
        form.reset();
        formMsg.textContent="Saved!";
        await loadIssues();
        setTimeout(()=>formMsg.textContent="",2000);
      } catch(err) { formErr.textContent=err.message||"Failed to save."; }
    });

    searchBox.addEventListener("input",()=>render(cache));
    loadIssues();
  </script>
</body>
</html>
